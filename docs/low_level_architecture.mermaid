graph TD
    A[Player Action] --> B[Narrative Generator]

    %% Narrative Generator Detailed Breakdown
    B --> B1[Validate Action]
    B1 --> B2[Retrieve Game State]
    B2 --> B3[Determine Narrative Structure]
    B3 --> B4[Fetch Context from Context Management]

    %% Character Manager Interaction
    B2 --> C[Character Manager]
    C --> C1[Get Character Data]
    C1 --> C2[Character Traits]
    C1 --> C3[Character Histories]
    C1 --> C4[Current Character States]

    %% World Manager Interaction
    B2 --> D[World Manager]
    D --> D1[Get Location Data]
    D1 --> D2[Location States]
    D1 --> D3[Environmental Factors]

    %% Map Manager Interaction
    B2 --> M[Map Manager] 
    %% New component
    M --> M1[Get Map Data]
    M1 --> M2[Terrain Types]
    M1 --> M3[Landmarks]
    M1 --> M4[Dynamic Elements]

    %% Event Manager Interaction
    B2 --> N[Event Manager] 
    %% New component
    N --> N1[Update Events]
    N1 --> N2[Check Active Events]
    N2 --> N3[Event Effects]

    %% Context Management Interaction
    B4 --> F[Context Management]
    F --> F1[Track Past Interactions]
    F --> F2[Maintain Story Arcs]
    F --> F3[Update Context Based on Player Actions]

    %% Narrative Structuring Detailed Breakdown
    B3 --> E[Narrative Structuring]
    E --> E1[Create Narrative Elements]
    E1 --> E2[Setup Elements]
    E1 --> E3[Conflict Elements]
    E1 --> E4[Resolution Elements]
    E1 --> E7[Adapt to Map State] 
    %% Interaction with Map
    E1 --> E8[Adapt to Events] 
    %% Interaction with Event Manager
    E --> E5[Select Narrative Template]
    E5 --> E6[Setup, Conflict, Resolution Templates]

    %% Prompt Manager Detailed Breakdown
    B3 --> P[Prompt Manager]
    P --> P1[Construct Initial Prompt]
    P1 --> P2[Fetch Relevant Data]
    P2 --> P3[Integrate Character, World, Map, Event Data]
    P1 --> P4[Adapt Prompt]
    P4 --> P5[Adjust Tone]
    P4 --> P6[Adjust Urgency]
    P4 --> P7[Select Appropriate Style]

    %% LLM Integration Detailed Breakdown
    P --> S[LLM Integration]
    S --> S1[Initialize Connection]
    S --> S2[Send Prompt to LLM]
    S2 --> S3[Receive Response from LLM]
    S3 --> S4[Process LLM Output]
    S4 --> S5[Pass Narrative Text Back]

    %% LLM Detailed Breakdown
    S2 --> W[LLM]
    W --> W1[Process Prompt]
    W1 --> W2[Generate Narrative Text]
    W2 --> S3

    %% Game Engine Detailed Breakdown
    S5 --> Y[Game Engine]
    Y --> Y1[Update Game State]
    Y1 --> Y2[Integrate Narrative Text]
    Y2 --> Y3[Display to Player]
    Y3 --> Player

    %% External Data and Dependencies
    G[External Dependencies] --> B4
    G --> P2
    G --> W1

    %% Data Stores
    subgraph Data Stores
        C2
        C3
        C4
        D2
        D3
        M2 
        M3 
        M4 
        E6
        N2 
        N3 
    end

    %% Context Tracking
    subgraph Context Tracking
        F1
        F2
        F3
    end

    %% Narrative Elements
    subgraph Narrative Elements
        E2
        E3
        E4
        E7 
        E8 
    end
